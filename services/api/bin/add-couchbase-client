#!/usr/bin/env bash
# Add the couchbase-client library as an editable dependency

set -e

# Change to the api directory
cd "$(dirname "$0")/.."

# Detect OS for sed compatibility
if [[ "$OSTYPE" == "darwin"* ]]; then
    SED_INPLACE=(sed -i '')
else
    SED_INPLACE=(sed -i)
fi

echo "ðŸ“¦ Adding couchbase-client library as editable dependency..."

$(dirname "$0")/uv add --editable ../lib/py/couchbase-client

# config with env vars
# init and deinit client

echo "âœ… Couchbase client library added successfully!"

# Add Couchbase environment variables to polytope.yml if they don't exist
echo ""
echo "ðŸ“ Adding Couchbase environment variables to polytope.yml..."

# Check if COUCHBASE_HOST already exists in the env section
if ! grep -q "COUCHBASE_HOST" polytope.yml; then
    # Add Couchbase env vars as last entries in the api tool env block (right before mounts:)
    "${SED_INPLACE[@]}" '/^  api:/,/^  [a-z-]*:/{
        /^          mounts:/i\
\
            - { name: COUCHBASE_HOST, value: couchbase }\
            - { name: COUCHBASE_USERNAME, value: user }\
            - { name: COUCHBASE_PASSWORD, value: password }\
            - { name: COUCHBASE_BUCKET, value: main }\
            - { name: COUCHBASE_PROTOCOL, value: couchbase }
    }' polytope.yml
    echo "âœ… Added Couchbase environment variables to polytope.yml"
else
    echo "â„¹ï¸  Couchbase environment variables already exist in polytope.yml"
fi

# Add the add-couchbase-model tool to polytope.yml if it doesn't already exist
if ! grep -q "api-add-couchbase-model:" polytope.yml; then
    echo ""
    echo "ðŸ“ Adding add-couchbase-model tool to polytope.yml..."

    cat >> polytope.yml << 'EOF'

  api-add-couchbase-model:
    info: Scaffold a new Python script and add it to pyproject.toml. Run this to create test scripts for your agents!
    params:
      - id: name
        info: Scaffolds a new Couchbase model with CRUD operations, Pydantic models, and automatic integration.
        type: str
    run:
      - tool: api
        args:
          id: api-add-couchbase-model
          restart-policy: never
          cmd: ./bin/add-couchbase-model {pt.param name}
          create: always
EOF

    echo "âœ… Added add-couchbase-model tool to polytope.yml"
fi

# Create the Couchbase configuration file
echo ""
echo "ðŸ“ Creating Couchbase configuration file..."

# Create the couchbase.py configuration file
cat > src/conf/couchbase.py << 'EOF'
from pydantic import BaseModel

from ..utils import auth, env, log
from ..utils.env import EnvVarSpec

from couchbase_client import CouchbaseConf

#### Env Vars ####

COUCHBASE_HOST = EnvVarSpec(
    id="COUCHBASE_HOST",
    default="couchbase"
)

COUCHBASE_USERNAME = EnvVarSpec(
    id="COUCHBASE_USERNAME",
    default="user"
)

COUCHBASE_PASSWORD = EnvVarSpec(
    id="COUCHBASE_PASSWORD",
    default="password",
    is_secret=True
)

COUCHBASE_BUCKET = EnvVarSpec(
    id="COUCHBASE_BUCKET",
    default="main"
)

COUCHBASE_PROTOCOL = EnvVarSpec(
    id="COUCHBASE_PROTOCOL",
    default="couchbase"
)

VALIDATED_ENV_VARS = [
    COUCHBASE_HOST,
    COUCHBASE_USERNAME,
    COUCHBASE_PASSWORD,
    COUCHBASE_BUCKET,
    COUCHBASE_PROTOCOL
]


#### Getters ####

def get_couchbase_conf():
    """Get Couchbase connection configuration."""
    return CouchbaseConf(
        host=env.parse(COUCHBASE_HOST),
        username=env.parse(COUCHBASE_USERNAME),
        password=env.parse(COUCHBASE_PASSWORD),
        bucket=env.parse(COUCHBASE_BUCKET),
        protocol=env.parse(COUCHBASE_PROTOCOL),
    )
EOF

echo "âœ… Created src/conf/couchbase.py"

# Create the init/couchbase.py file with initialization logic
echo ""
echo "ðŸ“ Creating init/couchbase.py with initialization logic..."

cat > src/init/couchbase.py << 'EOF'
"""Couchbase client initialization and deinitialization."""

from fastapi import FastAPI

from couchbase_client import CouchbaseClient
from ..conf.couchbase import get_couchbase_conf
from ..couchbase.models import MODELS
from ..utils.log import get_logger

logger = get_logger(__name__)


async def init_couchbase(app: FastAPI) -> None:
    """Initialize Couchbase client and models."""
    logger.info("Initializing Couchbase client...")
    couchbase_config = get_couchbase_conf()
    app.state.couchbase_client = CouchbaseClient(couchbase_config)
    await app.state.couchbase_client.init_connection()
    logger.info("Couchbase client connected successfully")

    if not MODELS:
        logger.info("No Couchbase models found. You can add models using the add-couchbase-model tool.")
    else:
        logger.info(f"Initializing {len(MODELS)} Couchbase model(s)...")
        for Model in MODELS:
            await Model.initialize(app.state.couchbase_client)
        logger.info(f"All {len(MODELS)} Couchbase model(s) initialized successfully")


async def deinit_couchbase(app: FastAPI) -> None:
    """Close Couchbase client connection."""
    logger.info("Closing Couchbase client connection...")
    await app.state.couchbase_client.close()
    logger.info("Couchbase client connection closed")
EOF

echo "âœ… Created src/init/couchbase.py"

# Inject Couchbase initialization calls into init/__init__.py
echo ""
echo "ðŸ“ Injecting Couchbase initialization calls into init/__init__.py..."

# Check if couchbase initialization is already present
if grep -q "init_couchbase" src/init/__init__.py; then
    echo "â„¹ï¸  Couchbase initialization already present in init/__init__.py"
else
    # Add import at the top of the file (after FastAPI import)
    "${SED_INPLACE[@]}" '/^from fastapi import FastAPI$/a\
\
from .couchbase import init_couchbase, deinit_couchbase
' src/init/__init__.py

    # Inject init call - insert after docstring line (single or multi-line)
    "${SED_INPLACE[@]}" '/async def init(app: FastAPI) -> None:/,/^async def deinit/{
        /""".*"""/{
            a\
    await init_couchbase(app)
        }
    }' src/init/__init__.py

    # Inject deinit call - insert after docstring line (single or multi-line)
    "${SED_INPLACE[@]}" '/async def deinit(app: FastAPI) -> None:/,${
        /""".*"""/{
            a\
    await deinit_couchbase(app)
        }
    }' src/init/__init__.py

    echo "âœ… Injected Couchbase initialization calls into init/__init__.py"
fi

# Update the main conf/__init__.py file to import couchbase configuration
echo ""
echo "ðŸ“ Updating src/conf/__init__.py to include Couchbase configuration..."

# Add import at the top of the file (after the existing imports)
if ! grep -q "from . import couchbase" src/conf/__init__.py; then
    # Add the import after the line with "from ..utils.env import EnvVarSpec"
    "${SED_INPLACE[@]}" '/from \.\.utils\.env import EnvVarSpec/a\
from . import couchbase\
from .couchbase import get_couchbase_conf
' src/conf/__init__.py
    echo "âœ… Added couchbase import to conf/__init__.py"
else
    echo "â„¹ï¸  Couchbase import already exists in conf/__init__.py"
fi

# Add getter function export if not already present
if ! grep -q "from .couchbase import get_couchbase_conf" src/conf/__init__.py; then
    "${SED_INPLACE[@]}" '/from \. import couchbase/a\
from .couchbase import get_couchbase_conf
' src/conf/__init__.py
    echo "âœ… Added get_couchbase_conf export to conf/__init__.py"
fi

# Add VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS) after the initial VALIDATED_ENV_VARS definition
if ! grep -q "VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS)" src/conf/__init__.py; then
    # Find the closing bracket of VALIDATED_ENV_VARS and add the extend statement after it
    "${SED_INPLACE[@]}" '/^VALIDATED_ENV_VARS = \[/,/^\]/{
        /^\]/a\
\
VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS)
    }' src/conf/__init__.py
    echo "âœ… Added VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS) to conf/__init__.py"
else
    echo "â„¹ï¸  VALIDATED_ENV_VARS extension already exists in conf/__init__.py"
fi

# Create the couchbase/models directory if it doesn't exist
mkdir -p src/couchbase/models

# Create the __init__.py file for the couchbase module if it doesn't exist
if [ ! -f src/couchbase/__init__.py ]; then
    touch src/couchbase/__init__.py
    echo "âœ… Created src/couchbase/__init__.py"
fi

# Create the __init__.py file for the models module if it doesn't exist
if [ ! -f src/couchbase/models/__init__.py ]; then
    echo ""
    echo "ðŸ“ Creating models registry..."
    cat > src/couchbase/models/__init__.py << 'EOF'
"""
Couchbase models registry.

All models are automatically registered here.
"""

# Import models here
# Example:
# from .users import UserModel

# Registry of all models
MODELS = [
    # Add model classes here
    # Example: UserModel
]
EOF
    echo "âœ… Created src/couchbase/models/__init__.py"
fi

echo ""
echo "âœ… Couchbase client setup complete!"
echo ""
echo "You can now:"
echo "  1. Import and use the Couchbase client in your code:"
echo "     from couchbase_client import CouchbaseClient"
echo "  2. Initialization is handled automatically in src/init/couchbase.py"
echo "  3. Call `__polytope__run(tool: api-add-couchbase-model, name: placeholder)` to add couchbase models."
